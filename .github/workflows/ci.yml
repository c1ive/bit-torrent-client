# CI: build with vcpkg + CMake (Ninja) and run doctest executables
#
# Key points:
# - Boots/uses third_party/vcpkg (clones if missing), installs manifest deps from vcpkg.json
# - Configures CMake with vcpkg toolchain
# - Builds Debug/Release on Linux/macOS/Windows (Ninja)
# - Runs the test executables added by your CMakeLists (bt-bencode-tests, bt-metadata-loader-tests, bt-connection-tests)
#   â€” does NOT rely on ctest; runs the built doctest binaries directly and collects per-binary logs
# - Caches vcpkg and the build dir to speed up repeated runs
#
# Adjust the triplets mapping if you use different toolchain/triplet names for macOS or Windows.

name: CI - build & run doctest executables

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

env:
  BUILD_DIR: build

jobs:
  build-and-run-tests:
    name: Build & Run Tests (ubuntu-latest / Debug)
    runs-on: ubuntu-latest
    strategy:
      matrix:
        build_type: [Debug]

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: true

      - name: Choose vcpkg triplet
        id: triplet
        run: |
          echo "TRIPLET=x64-linux" >> $GITHUB_OUTPUT
        shell: bash

      - name: Cache vcpkg packages & build dir
        uses: actions/cache@v4
        with:
          path: |
            third_party/vcpkg/installed
            third_party/vcpkg/packages
            third_party/vcpkg/downloads
            ${{ env.BUILD_DIR }}
          key: ${{ runner.os }}-vcpkg-${{ hashFiles('vcpkg.json') }}-cmake-${{ matrix.build_type }}
          restore-keys: |
            ${{ runner.os }}-vcpkg-

      - name: Install build prerequisites (Ubuntu)
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential cmake ninja-build git
        shell: bash

      - name: Bootstrap / install vcpkg (Ubuntu)
        run: |
          VCPKG_DIR="${GITHUB_WORKSPACE}/third_party/vcpkg"
          if [ ! -d "$VCPKG_DIR" ]; then
            git clone --depth 1 https://github.com/microsoft/vcpkg "$VCPKG_DIR"
          fi
          pushd "$VCPKG_DIR"
          ./bootstrap-vcpkg.sh -disableMetrics
          ./vcpkg install --manifest --triplet "${{ steps.triplet.outputs.TRIPLET }}"
          popd
        shell: bash

      - name: Configure (CMake with vcpkg toolchain)
        run: |
          cmake -S . -B "${{ env.BUILD_DIR }}" -G Ninja \
            -DCMAKE_BUILD_TYPE=${{ matrix.build_type }} \
            -DCMAKE_EXPORT_COMPILE_COMMANDS=ON \
            -DCMAKE_TOOLCHAIN_FILE="${{ github.workspace }}/third_party/vcpkg/scripts/buildsystems/vcpkg.cmake"
        shell: bash

      - name: Build
        run: cmake --build "${{ env.BUILD_DIR }}" --config ${{ matrix.build_type }} --parallel
        shell: bash

      - name: Run doctest executables and collect logs
        id: run-tests
        run: |
          set -euo pipefail
          mkdir -p test-logs
          exit_code=0

          mapfile -t TEST_BINS < <(find "${{ env.BUILD_DIR }}" -type f \( -name "*-tests" -o -name "*-tests.exe" \) 2>/dev/null || true)

          if [ ${#TEST_BINS[@]} -eq 0 ]; then
            echo "No test binaries found in ${{ env.BUILD_DIR }}"
            find "${{ env.BUILD_DIR }}" -maxdepth 2 -print || true
            exit 1
          fi

          for tb in "${TEST_BINS[@]}"; do
            name="$(basename "$tb")"
            echo "=== Running $name ==="
            chmod +x "$tb" || true
            if ! "$tb" 2>&1 | tee "test-logs/${name}.txt"; then
              exit_code=1
            fi
            echo "=== Exit code: $exit_code ==="
          done

          if [ "$exit_code" -ne 0 ]; then
            echo "One or more tests failed. See artifacts in test-logs/"
            exit $exit_code
          fi
        shell: bash

      - name: Upload test logs
        uses: actions/upload-artifact@v4
        with:
          name: doctest-logs-ubuntu-${{ matrix.build_type }}
          path: test-logs

      - name: Upload build dir (for debugging)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: build-ubuntu-${{ matrix.build_type }}
          path: ${{ env.BUILD_DIR }}